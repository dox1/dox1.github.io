<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>لوحة حيّنا الذكية — بلدية الخيثر (موبايل)</title>
<meta name="theme-color" content="#0b1220"/>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase compat (Realtime DB) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
:root{
  --bg:#0b1220; --card:#0f1a2b; --muted:#9fb0d7; --accent:#2dd4bf; --accent2:#4f46e5; --txt:#e9f2ff; --line:rgba(255,255,255,.06);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;font-family:'Cairo',system-ui,Segoe UI,Arial,sans-serif;background:radial-gradient(80% 120% at 50% 0%,#12203a 0%,var(--bg) 60%);color:var(--txt)}
.container{max-width:640px;margin:0 auto;padding:12px}
header{position:sticky;top:0;background:linear-gradient(180deg,rgba(3,7,18,.7),transparent);backdrop-filter:blur(6px);z-index:30;padding:10px 0}
.header-row{display:flex;gap:12px;align-items:center}
.logo{width:46px;height:46px;border-radius:12px;background:conic-gradient(from 200deg,var(--accent),var(--accent2));box-shadow:0 8px 30px rgba(79,70,229,.22)}
h1{margin:0;font-size:18px}
.sub{font-size:12px;opacity:.85;margin-top:4px;color:var(--muted)}
canvas#stars{position:fixed;inset:0;z-index:-1}

/* Mobile optimized */
.section{margin:12px 0;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid var(--line);overflow:hidden}
.toggle{width:100%;background:none;border:0;padding:14px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;touch-action:manipulation}
.toggle h2{margin:0;font-size:16px;color:#80ff98;}
.chev{transition:transform .28s ease}
.section.open .chev{transform:rotate(180deg)}
.content{max-height:0;overflow:hidden;transition:max-height .45s ease}
.section.open .content{max-height:2000px}

/* forms and lists */
.card{padding:12px}
.searchbar{display:flex;gap:8px;margin-bottom:10px}
.searchbar input, .searchbar select, .input, textarea {flex:1;padding:12px;border-radius:10px;border:1px solid var(--line);background:transparent;color:inherit;font-size:15px}
select{min-width:120px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:12px 14px;border-radius:12px;border:0;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001;font-weight:800;font-size:15px}
.btn.secondary{background:transparent;border:1px solid var(--line);color:var(--txt);font-weight:700}
.btn.small{padding:8px 10px;font-size:14px}
.btn.danger{background:linear-gradient(90deg,#ff7b7b,#ff4d4d);color:#100}
.call-btn{display:inline-block;padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,#ffd166,#ffa500);color:#001;font-weight:800}

#map-weather,#map-services{height:220px;border-radius:12px;margin-top:8px}
.wx-now{display:flex;align-items:baseline;gap:10px}
.wx-now .temp{font-size:34px;font-weight:800}
.wx-list{display:flex;gap:8px;overflow:auto;padding:8px 2px}
.wx-card{min-width:76px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);text-align:center;font-size:13px}
.list-item{padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px;border:1px solid var(--line);margin-bottom:10px}
.item-row{display:flex;justify-content:space-between;align-items:center}
.footer{color:var(--muted);font-size:12px;text-align:center;padding:18px 0}

/* About grid (paired sections) */
.about-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.about-card{padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid var(--line);cursor:pointer;display:flex;flex-direction:column;justify-content:space-between;min-height:100px}
.about-card h3{margin:0;font-size:15px}
.about-list{margin-top:8px}

/* Admin overlay */
.admin-overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(2,6,23,.85),rgba(2,6,23,.95));display:none;align-items:flex-start;justify-content:flex-start;z-index:90;padding:12px;overflow:auto;-webkit-overflow-scrolling:touch}
.admin-card{width:100%;max-width:700px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:12px;border:1px solid var(--line);box-shadow:0 20px 60px rgba(0,0,0,.6);margin-top:24px}
.tabbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.tabbar button{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--txt);font-size:14px}
.tabbar button.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001;font-weight:800}
.tab{display:none}
.tab.active{display:block}

/* admin list item controls */
.admin-list-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid var(--line);margin-bottom:8px}
.admin-list-item .meta{font-size:13px;color:var(--muted)}

/* login box */
.login-box{display:flex;flex-direction:column;gap:10px;padding:12px;border-radius:12px;background:rgba(0,0,0,0.25);border:1px solid var(--line);max-width:420px;margin:40px auto}
.login-box input{padding:12px;border-radius:8px;border:1px solid var(--line);background:transparent;color:inherit}

/* images */
.item-image{width:100%;max-height:160px;object-fit:cover;border-radius:8px;margin-top:8px;}

/* disable page scroll when admin open */
.no-scroll{overflow:hidden !important}

/* back top & install & open admin */
#back-top{position:fixed;bottom:18px;left:18px;background:var(--accent2);color:#001;padding:10px;border-radius:50%;display:none;z-index:50;cursor:pointer}
.install-btn{position:fixed;bottom:18px;right:18px;background:var(--accent);color:#001;padding:10px 14px;border-radius:12px;z-index:50;font-weight:800;display:none}
#openAdmin{position:fixed;bottom:18px;right:86px;background:var(--accent2);color:#001;padding:10px 12px;border-radius:12px;z-index:50;font-weight:800}
@media (max-width:420px){
  .about-grid{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
<canvas id="stars"></canvas>

<div class="container">
  <header>
    <div class="header-row">
      <div class="logo" aria-hidden="true"></div>
      <div style="flex:1">
        <h1>لوحة حيّنا الذكيّة</h1>
        <div class="sub" id="place">بلدية الخيثر — ولاية البيض</div>
      </div>
      <div style="text-align:left">
        <small class="muted" id="time-now">—</small>
      </div>
    </div>
  </header>

  <!-- About municipality (paired cards) -->
  <section class="section open" id="sec-about">
    <button class="toggle" aria-expanded="true">
      <h2>حول بلدية الخيثر</h2>
      <svg class="chev" width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
    <div class="content">
      <div class="card">
        <div class="about-grid">
          <div class="about-card" data-key="mosques"><h3>🕌 مساجد الخيثر</h3><div class="muted">قائمة المساجد والمعلومات</div></div>
          <div class="about-card" data-key="cafes"><h3>☕ مقاهي الخيثر</h3><div class="muted">أماكن للقاء والاسترخاء</div></div>
          <div class="about-card" data-key="heritage"><h3>🏛️ تراث الخيثر</h3><div class="muted">معلومات ومعالم تراثية</div></div>
          <div class="about-card" data-key="areas"><h3>📍 مناطق الخيثر</h3><div class="muted">الأحياء والنقاط المهمة</div></div>
        </div>

        <div id="about-details" style="margin-top:12px"></div>
      </div>
    </div>
  </section>

  <!-- Weather -->
  <section class="section" id="sec-weather">
    <button class="toggle" aria-expanded="false">
      <h2>الطقس — الخيثر</h2>
      <svg class="chev" width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
    <div class="content">
      <div class="card">
        <div class="wx-now">
          <div class="temp" id="now-temp">--°</div>
          <div>
            <div id="now-desc">جاري التحميل…</div>
            <div class="muted" id="now-extra">—</div>
          </div>
        </div>
        <div id="map-weather" style="margin-top:12px"></div>
        <div style="margin-top:10px" class="wx-list" id="hourly"></div>
        <div style="margin-top:12px">
          <strong>توقعات الأيام القادمة</strong>
          <div class="wx-list" id="daily"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Services (kept) -->
  <section class="section" id="sec-services">
    <button class="toggle" aria-expanded="false">
      <h2>خدمات النقل والتوصيل وحافلات السفر</h2>
      <svg class="chev" width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
    <div class="content">
      <div class="card">
        <div class="searchbar">
          <input id="q" placeholder="ابحث بالاسم/الوجهة/الوجبة/البلد..." />
          <select id="filter"><option value="all">الكل</option><option value="cars">سيارات نقل</option><option value="food">مطاعم</option><option value="buses">حافلات</option></select>
        </div>

        <div>
          <strong>🚕 سيارات النقل المحلي</strong>
          <div id="cars"></div>
        </div>

        <div style="margin-top:10px">
          <strong>🍔 توصيلات المطاعم</strong>
          <div id="food"></div>
        </div>

        <div style="margin-top:10px">
          <strong>🚌 حافلات السفر</strong>
          <div id="buses"></div>
        </div>

        <div style="margin-top:12px">
          <strong>خريطة الخدمات</strong>
          <div id="map-services" style="margin-top:8px"></div>
        </div>

      </div>
    </div>
  </section>

  <!-- Emergency -->
  <section class="section" id="sec-emergency">
    <button class="toggle" aria-expanded="false">
      <h2>اتصال سريع بالطوارئ</h2>
      <svg class="chev" width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
    <div class="content">
      <div class="card">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <a class="btn" href="tel:14">🚑 الإسعاف — 14</a>
          <a class="btn" href="tel:17">🚓 الشرطة — 17</a>
          <a class="btn" href="tel:1021">🔥 الحماية المدنية — 1021</a>
        </div>
        <hr style="margin:12px 0;border:0;border-top:1px solid rgba(255,255,255,.03)">
        <div>
          <strong>مشاركة موقعك بسرعة</strong>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn secondary" id="share-wa">مشاركة عبر واتساب</button>
            <button class="btn secondary" id="share-sms">مشاركة عبر SMS</button>
          </div>
          <div style="margin-top:8px"><small class="muted" id="share-status">—</small></div>
        </div>
      </div>
    </div>
  </section>

  <div class="footer">© <span id="year"></span> لوحة حيّنا — بلدية الخيثر</div>
</div>

<button id="back-top" title="عد للأعلى">↑</button>
<button id="install" class="install-btn">تثبيت</button>
<button id="openAdmin" class="install-btn" style="right:86px;display:block">لوحة الإدارة</button>

<!-- Admin overlay with LOGIN and ADMIN CARD -->
<div class="admin-overlay" id="adminOverlay" role="dialog" aria-modal="true">
  <!-- Login box (shown when not authenticated) -->
  <div id="loginBox" class="login-box" style="display:none">
    <div style="font-weight:800;font-size:16px">تسجيل دخول لوحة الإدارة</div>
    <input id="loginPass" type="password" placeholder="أدخل كلمة المرور" />
    <div style="display:flex;gap:8px;justify-content:center">
      <button class="btn" id="loginBtn">تسجيل الدخول</button>
      <button class="btn secondary" id="closeLogin">إلغاء</button>
    </div>
    <div style="margin-top:8px" class="muted">خاصة بإدار الموقع</div>
  </div>

  <div class="admin-card" id="adminCard" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div>
        <strong style="font-size:16px">لوحة الإدارة — إدارة المحتوى</strong>
        <div class="muted" style="font-size:12px">أضف/عدّل/احذف — محفوظ في Firebase</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="closeAdmin">× إغلاق</button>
      </div>
    </div>

    <!-- عنصر عرض عدد الزوار -->
    <div style="margin:10px 0;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center">
      <div style="font-size:14px">عدد زوار الموقع</div>
      <div id="visitor-count" style="font-weight:800;font-size:18px">—</div>
    </div>

    <div class="tabbar" id="adminTabs">
      <button class="active" data-tab="items">قائمة المحتوى</button>
      <button data-tab="add">إضافة</button>
      <button data-tab="import">استيراد/تصدير</button>
      <button data-tab="settings">الإعدادات</button>
    </div>

    <div id="tab-items" class="tab active" style="display:block">
      <div style="margin-bottom:8px" class="inline">
        <select id="adminFilter"><option value="all">عرض الكل</option>
          <option value="cars">سيارات نقل</option><option value="food">مطاعم</option><option value="buses">حافلات</option>
          <option value="mosques">مساجد</option><option value="cafes">مقاهي</option><option value="heritage">تراث</option><option value="areas">مناطق</option>
        </select>
        <input id="adminSearch" class="input" placeholder="ابحث بالاسم أو الوجهة..." />
        <button class="btn small" id="refreshLists">تحديث</button>
      </div>

      <!-- قائمة الخدمات و المحتوى في الإدارة -->
      <div id="adminList" style="margin-bottom:12px"></div>
    </div>

    <div id="tab-add" class="tab" style="display:none">
      <div style="display:flex;gap:10px;flex-direction:column">
        <label>نوع المحتوى
          <select id="addType">
            <option value="cars">سيارة نقل</option>
            <option value="food">مطعم/توصيل</option>
            <option value="buses">حافلة سفر</option>
            <option value="mosques">مسجد</option>
            <option value="cafes">مقهى</option>
            <option value="heritage">تراث</option>
            <option value="areas">منطقة</option>
          </select>
        </label>
        <div id="formFields"></div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="addSave">إضافة / حفظ</button>
          <button class="btn secondary" id="addClear">مسح الحقول</button>
        </div>
      </div>
    </div>

    <div id="tab-import" class="tab" style="display:none">
      <div style="display:flex;gap:8px;flex-direction:column">
        <strong>تصدير البيانات</strong>
        <button class="btn" id="exportJson">تنزيل JSON</button>
        <hr>
        <strong>استيراد البيانات</strong>
        <textarea id="importArea" rows="6" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid var(--line);color:inherit"></textarea>
        <div style="display:flex;gap:8px">
          <button class="btn" id="importPaste">استيراد من الحقل</button>
          <input type="file" id="importFile" accept=".json" />
        </div>
      </div>
    </div>

    <div id="tab-settings" class="tab" style="display:none">
      <div style="display:flex;flex-direction:column;gap:8px">
        <label>كلمة مرور لوحة الإدارة (تغيير)</label>
        <input id="newAdminPass" class="input" placeholder="أدخل كلمة مرور جديدة" type="password"/>
        <div style="display:flex;gap:8px">
          <button class="btn" id="changeAdminPass">حفظ كلمة المرور</button>
        </div>
        <hr>
        <div>
          <strong>مسح البيانات المحلية</strong>
          <p class="muted">احذف كل البيانات المخزنة في المتصفح (لا يؤثر على Firebase).</p>
          <button class="btn danger" id="clearAll">مسح الكل محليًا</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ==================== Firebase config (من إعداداتك) ==================== */
const firebaseConfig = {
  apiKey: "AIzaSyAfzvc8eWqRBSXuV41tV7rUcJgEXVnDd2I",
  authDomain: "adminpro-eee9b.firebaseapp.com",
  databaseURL: "https://adminpro-eee9b-default-rtdb.firebaseio.com",
  projectId: "adminpro-eee9b",
  storageBucket: "adminpro-eee9b.firebasestorage.app",
  messagingSenderId: "589947340027",
  appId: "1:589947340027:web:ac2fa063b6acae90d59c5e",
  measurementId: "G-D4P7EF34DY"
};
try { firebase.initializeApp(firebaseConfig); } catch(e){ console.warn('firebase init:', e); }
const rtdb = firebase.database();
/* ====================================================================================== */

/* ========== visitor counter ========== */
const VISITED_KEY = 'poostili_visited_at';
const ONE_HOUR = 1000 * 60 * 60;
async function incrementVisitorIfNeeded(){
  try{
    const last = Number(localStorage.getItem(VISITED_KEY) || 0);
    if(!last || (Date.now() - last) > ONE_HOUR){
      const ref = rtdb.ref('site/visitorCount');
      await ref.transaction(current => (current || 0) + 1);
      localStorage.setItem(VISITED_KEY, String(Date.now()));
    }
  }catch(err){ console.warn('visitor increment error', err); }
}
function attachVisitorListener(){ try{ const ref = rtdb.ref('site/visitorCount'); ref.on('value', snap => { const v = snap.val() || 0; const el = document.getElementById('visitor-count'); if(el) el.textContent = v; }); }catch(e){ console.warn('attach visitor listener', e); } }
incrementVisitorIfNeeded();

/* ========== data shape & local fallback ========== */
const STORAGE_KEY = 'poostili_services_v1';
const DEFAULT_PASS = 'admin123';
let DATA = {cars:[], food:[], buses:[], mosques:[], cafes:[], heritage:[], areas:[]};

/* load local fallback */
(function loadLocal(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw) DATA = JSON.parse(raw); }catch(e){} })();
function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA)); }

/* Save to Firebase (site/data) */
async function saveToFirebase(){
  try{ await rtdb.ref('site/data').set(DATA); }catch(e){ console.warn('saveToFirebase error', e); }
}

/* Listen remote -> update local & UI */
rtdb.ref('site/data').on('value', snap => {
  if(snap.exists()){
    DATA = snap.val();
    saveLocal();
    renderAllMain();
    renderAdminList();
    updateServiceMarkers();
  }
});

/* ensure remote initially (first-run) */
(async function ensureRemoteData(){
  try{
    const snap = await rtdb.ref('site/data').once('value');
    if(!snap.exists()){
      await rtdb.ref('site/data').set(DATA);
    } else {
      DATA = snap.val();
      saveLocal();
    }
  }catch(e){ console.warn('ensureRemoteData', e); }
})();

/* ========== stars ========== */
const starCanvas = document.getElementById('stars');
const sctx = starCanvas.getContext('2d');
let stars=[];
function resize(){ starCanvas.width=innerWidth; starCanvas.height=innerHeight; }
addEventListener('resize', resize); resize();
for(let i=0;i<140;i++) stars.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,r:Math.random()*1.2+0.3,v:Math.random()*0.3+0.02,a:Math.random()*0.8+0.2});
(function loop(){ sctx.clearRect(0,0,starCanvas.width,starCanvas.height); stars.forEach(s=>{ s.y+=s.v; if(s.y>innerHeight){s.y=0;s.x=Math.random()*innerWidth;} sctx.globalAlpha=s.a; sctx.beginPath(); sctx.arc(s.x,s.y,s.r,0,Math.PI*2); sctx.fillStyle="#fff"; sctx.fill(); }); requestAnimationFrame(loop); })();

/* ========== helpers ========== */
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
function telBtn(num){ return `<a class="call-btn" href="tel:${(num||'').replace(/\s+/g,'')}">اتصال</a>`; }
function getPosition(){ return new Promise((res,rej)=>{ if(!navigator.geolocation) return rej('no geo'); navigator.geolocation.getCurrentPosition(p=>res(p.coords), e=>rej(e), {enableHighAccuracy:true,timeout:9000}); }); }

/* image url detection */
function isImageUrl(url){
  if(!url || typeof url !== 'string') return false;
  const trimmed = url.split('?')[0].split('#')[0];
  return /(\.jpg|\.jpeg|\.png|\.webp|\.gif|\.bmp|\.svg)$/i.test(trimmed) || /^data:image\//.test(url);
}

/* create image html safely */
function imageHtml(url, alt){
  if(!url) return '';
  return `<img src="${url}" alt="${alt||''}" class="item-image" loading="lazy" />`;
}

/* ========== maps & weather (safer init) ========== */
const FALLBACK = {lat:33.68, lon:1.02};
let mapWeather, mapServices, weatherMarker, servicesMarkers = [];
function initMaps(lat,lon){
  try{
    if(!mapWeather){ mapWeather = L.map('map-weather',{zoomControl:true}).setView([lat,lon],11); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(mapWeather); weatherMarker = L.marker([lat,lon]).addTo(mapWeather); }
    else { mapWeather.setView([lat,lon],11); weatherMarker.setLatLng([lat,lon]); }
    if(!mapServices){ mapServices = L.map('map-services',{zoomControl:true}).setView([lat,lon],11); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(mapServices); }
    updateServiceMarkers();
  }catch(e){ console.warn('map init error', e); }
}
function updateServiceMarkers(){
  if(!mapServices) return;
  servicesMarkers.forEach(m=>mapServices.removeLayer(m)); servicesMarkers=[];
  const all = [...(DATA.cars||[]), ...(DATA.food||[]), ...(DATA.buses||[]), ...(DATA.mosques||[]), ...(DATA.cafes||[]), ...(DATA.areas||[])];
  all.forEach(item=>{
    if(!item || !item.lat || !item.lon) return;
    const m = L.marker([item.lat,item.lon]).addTo(mapServices);
    let html='';
    if(item.name) html += `<b>${item.name}</b><br/>${item.dest||''}<br/>${item.phone?`<a href="tel:${item.phone.replace(/\s+/g,'')}">اتصال</a>`:''}`;
    if(item.restaurant) html += `<b>${item.restaurant}</b><br/>${item.meals||''}<br/>${item.phone?`<a href="tel:${item.phone.replace(/\s+/g,'')}">اتصال</a>`:''}`;
    if(item.country) html += `<b>حافلة إلى ${item.country}</b><br/>إقلاع: ${item.depart||''}<br/>${item.owner?item.owner+'<br/>':''}${item.phone?`<a href="tel:${item.phone.replace(/\s+/g,'')}">اتصال</a>`:''}`;
    if(item.mosqueName) html += `<b>${item.mosqueName}</b><br/>${item.info||''}`;
    if(item.cafeName) html += `<b>${item.cafeName}</b><br/>${item.info||''}`;
    if(item.areaName) html += `<b>${item.areaName}</b><br/>${item.info||''}`;
    m.bindPopup(html);
    servicesMarkers.push(m);
  });
  if(servicesMarkers.length) mapServices.fitBounds(servicesMarkers.map(m=>m.getLatLng()),{padding:[30,30]});
}
function focusOn(lat,lon){
  if(mapServices) mapServices.setView([lat,lon],13);
  else if(mapWeather) mapWeather.setView([lat,lon],13);
}

/* ========== weather (open-meteo) ========== */
function weatherCodeToArabic(code){ const map = {0:'صافي',1:'قليل السحب',2:'غائم جزئياً',3:'غائم',45:'ضباب',48:'ضباب جليدي',51:'رذاذ خفيف',53:'رذاذ متوسط',55:'رذاذ كثيف',61:'مطر خفيف',63:'مطر معتدل',65:'مطر غزير',71:'ثلج خفيف',73:'ثلج معتدل',75:'ثلج غزير',80:'زخات مطر',81:'زخات مطر قوية',82:'زخات مطر عنيفة',95:'عاصفة رعدية',96:'عاصفة رعدية مع برد خفيف',99:'عاصفة رعدية مع برد قوي'}; return map[code]||'حالة جوية'; }
async function loadWeather(lat,lon){
  try{
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weathercode,relativehumidity_2m,windspeed_10m&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto`;
    const r = await fetch(url); const data = await r.json(); if(!data) throw 0;
    const nowTemp = data.hourly.temperature_2m[0], nowCode = data.hourly.weathercode[0], humidity = data.hourly.relativehumidity_2m[0], wind = data.hourly.windspeed_10m[0];
    $('#now-temp').textContent = Math.round(nowTemp)+'°'; $('#now-desc').textContent = weatherCodeToArabic(nowCode); $('#now-extra').textContent = `رطوبة ${Math.round(humidity)}% • رياح ${Math.round(wind)} كم/س`;
    const hours = data.hourly.time.slice(0,24).map((t,i)=>({t: t, temp: data.hourly.temperature_2m[i], code: data.hourly.weathercode[i]}));
    $('#hourly').innerHTML = hours.map(h=>`<div class="wx-card"><div>${new Date(h.t).toLocaleTimeString('ar-DZ',{hour:'2-digit'})}</div><div style="font-weight:800">${Math.round(h.temp)}°</div><div class="muted">${weatherCodeToArabic(h.code)}</div></div>`).join('');
    const days = data.daily.time.map((d,i)=>({date:d,min:data.daily.temperature_2m_min[i],max:data.daily.temperature_2m_max[i],code:data.daily.weathercode[i]}));
    $('#daily').innerHTML = days.map(d=>`<div class="wx-card"><div>${new Date(d.date).toLocaleDateString('ar-DZ',{weekday:'short',day:'numeric'})}</div><div style="font-weight:800">${Math.round(d.max)}° / ${Math.round(d.min)}°</div><div class="muted">${weatherCodeToArabic(d.code)}</div></div>`).join('');
  }catch(e){ console.warn(e); $('#now-desc').textContent='تعذّر جلب الطقس'; }
}

/* ========== render lists (with images) ========== */
function renderCars(list){ const el = $('#cars'); if(!el) return; if(!list.length){ el.innerHTML = '<div class="muted">لا توجد سيارات حالياً</div>'; return; } el.innerHTML = list.map((x,i)=>{
  const img = isImageUrl(x.image) ? imageHtml(x.image, x.name) : '';
  return `<div class="list-item"><div><strong>${x.name||'لا اسم'}</strong><div class="muted">${x.note||''}</div></div>${img}<div class="item-row"><div class="muted">${x.dest||''}</div><div>${x.phone||''}</div></div><div style="display:flex;gap:8px">${telBtn(x.phone)} <button class="btn secondary" onclick="focusOn(${x.lat||33.68},${x.lon||1.02})">الموقع</button></div></div>` }).join(''); }

function renderFood(list){ const el = $('#food'); if(!el) return; if(!list.length){ el.innerHTML = '<div class="muted">لا توجد مطاعم</div>'; return; } el.innerHTML = list.map((x,i)=>{
  const img = isImageUrl(x.image) ? imageHtml(x.image, x.restaurant) : '';
  return `<div class="list-item"><div><strong>${x.restaurant||'مطعم'}</strong></div>${img}<div class="muted">${x.meals||''}</div><div class="item-row"><div class="muted">${x.phone||''}</div><div>${telBtn(x.phone)}</div></div><div><button class="btn secondary" onclick="focusOn(${x.lat||33.68},${x.lon||1.02})">الموقع</button></div></div>` }).join(''); }

function renderBuses(list){ const el = $('#buses'); if(!el) return; if(!list.length){ el.innerHTML = '<div class="muted">لا توجد رحلات</div>'; return; } el.innerHTML = list.map((x,i)=>{
  const img = isImageUrl(x.image) ? imageHtml(x.image, `حافلة إلى ${x.country}`) : '';
  return `<div class="list-item"><div><strong>إلى ${x.country||''}</strong> — <small class="muted">إقلاع ${x.depart||''}</small></div>${img}<div class="muted">${x.owner||''} — ${x.phone||''}</div><div style="display:flex;gap:8px">${telBtn(x.phone)} <button class="btn secondary" onclick="focusOn(${x.lat||33.68},${x.lon||1.02})">الموقع</button></div></div>` }).join(''); }

/* new: render places for about-details (with image display) */
function renderPlacesList(key){
  const container = $('#about-details');
  const list = DATA[key] || [];
  if(!list.length){ container.innerHTML = `<div class="muted">لا توجد بيانات في هذا القسم بعد</div>`; return; }
  container.innerHTML = list.map((it,idx)=>{
    const title = it.mosqueName || it.cafeName || it.title || it.areaName || it.restaurant || it.name || 'عنصر';
    const desc = it.info || it.meals || it.note || it.dest || '';
    const img = isImageUrl(it.image) ? imageHtml(it.image, title) : '';
    const phone = it.phone || '';
    const coordsBtn = (it.lat && it.lon) ? `<button class="btn secondary" onclick="focusOn(${it.lat},${it.lon})">الموقع</button>` : '';
    return `<div class="list-item">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${title}</strong><div class="muted">${desc}</div></div>
        <div style="text-align:left">${phone?`<div class="muted">${phone}</div>${telBtn(phone)}`:''}</div>
      </div>
      ${img}
      <div style="display:flex;gap:8px;margin-top:8px">${coordsBtn}</div>
    </div>`;
  }).join('');
}

/* render about cards click handlers */
$$('.about-card').forEach(card=>{
  card.addEventListener('click', ()=>{
    const key = card.dataset.key;
    $$('.about-card').forEach(c=>c.style.boxShadow='none');
    card.style.boxShadow = '0 8px 30px rgba(0,0,0,0.3)';
    renderPlacesList(key);
  });
});

/* render everything main */
function renderAllMain(){ renderCars(DATA.cars||[]); renderFood(DATA.food||[]); renderBuses(DATA.buses||[]); updateServiceMarkers(); }

/* ========== filtering ========== */
function renderFiltered(){ const q = $('#q').value.trim().toLowerCase(); const f = $('#filter').value;
  const cars = (DATA.cars||[]).filter(x=> (f==='all'||f==='cars') && (!q || (x.name||'').toLowerCase().includes(q) || (x.dest||'').toLowerCase().includes(q) || (x.phone||'').toLowerCase().includes(q)) );
  const food = (DATA.food||[]).filter(x=> (f==='all'||f==='food') && (!q || (x.restaurant||'').toLowerCase().includes(q) || (x.meals||'').toLowerCase().includes(q) || (x.phone||'').toLowerCase().includes(q)) );
  const buses = (DATA.buses||[]).filter(x=> (f==='all'||f==='buses') && (!q || (x.country||'').toLowerCase().includes(q) || (x.owner||'').toLowerCase().includes(q) || (x.phone||'').toLowerCase().includes(q)) );
  renderCars(cars); renderFood(food); renderBuses(buses);
  if(mapServices){
    servicesMarkers.forEach(m=>mapServices.removeLayer(m)); servicesMarkers=[];
    [...cars,...food,...buses].forEach(item=>{ if(!item.lat||!item.lon) return; const m=L.marker([item.lat,item.lon]).addTo(mapServices); let html=''; if(item.name) html+=`<b>${item.name}</b><br/>${item.dest||''}<br/>${item.phone?`<a href="tel:${item.phone.replace(/\s+/g,'')}">اتصال</a>`:''}`; if(item.restaurant) html+=`<b>${item.restaurant}</b><br/>${item.meals||''}<br/>${item.phone?`<a href="tel:${item.phone.replace(/\s+/g,'')}">اتصال</a>`:''}`; if(item.country) html+=`<b>حافلة: ${item.country}</b><br/>إقلاع: ${item.depart||''}<br/>${item.owner||''}<br/>${item.phone?`<a href="tel:${item.phone.replace(/\s+/g,'')}">اتصال</a>`:''}`; m.bindPopup(html); servicesMarkers.push(m); });
    if(servicesMarkers.length) mapServices.fitBounds(servicesMarkers.map(m=>m.getLatLng()),{padding:[30,30]});
  }
}

/* ========== Admin logic ========== */
const adminOverlay = $('#adminOverlay'), loginBox = $('#loginBox'), adminCard = $('#adminCard');
const openAdminBtn = $('#openAdmin'), closeAdminBtn = $('#closeAdmin'), loginBtn = $('#loginBtn'), closeLogin = $('#closeLogin');

openAdminBtn.addEventListener('click', ()=> showLogin());
closeAdminBtn && closeAdminBtn.addEventListener && closeAdminBtn.addEventListener('click', ()=> closeAdmin());
closeLogin.addEventListener('click', ()=> { loginBox.style.display='none'; adminOverlay.style.display='none'; document.body.classList.remove('no-scroll'); });

function showLogin(){ adminOverlay.style.display='flex'; loginBox.style.display='block'; adminCard.style.display='none'; document.body.classList.add('no-scroll'); $('#loginPass').value=''; $('#loginPass').focus(); }
function closeAdmin(){ adminOverlay.style.display='none'; adminCard.style.display='none'; loginBox.style.display='none'; document.body.classList.remove('no-scroll'); }

/* fetch admin password */
async function fetchAdminPassword(){
  try{
    const snapRoot = await rtdb.ref('admin_password').once('value');
    if(snapRoot.exists()) return snapRoot.val();
    const snapNode = await rtdb.ref('admin/password').once('value');
    if(snapNode.exists()) return snapNode.val();
    return null;
  }catch(e){ console.warn('fetchAdminPassword', e); return null; }
}

loginBtn.addEventListener('click', async ()=> {
  const pw = $('#loginPass').value || '';
  try{
    const real = await fetchAdminPassword();
    const expected = real || localStorage.getItem('local_admin_pass') || DEFAULT_PASS;
    if(pw === expected){
      loginBox.style.display='none'; adminCard.style.display='block'; showTab('items'); renderAdminList(); $('#loginPass').value=''; attachVisitorListener();
    } else { alert('كلمة المرور خاطئة'); }
  }catch(err){
    console.warn('login error', err);
    alert('حدث خطأ أثناء التحقق. تأكد من اتصال الإنترنت.');
  }
});

/* tabs control */
$$('#adminTabs button').forEach(btn => btn.addEventListener('click', ()=> { $$('#adminTabs button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); showTab(btn.dataset.tab); }));
function showTab(name){ $$('.tab').forEach(t=>t.style.display='none'); const el = $(`#tab-${name}`); if(el) el.style.display='block'; }

/* admin add/edit form builder */
const formFields = $('#formFields');
function buildFormFor(type,data){
  formFields.innerHTML='';
  if(type==='cars'){
    formFields.innerHTML = `
      <label>اسم السائق: <input id="f_name" class="input" value="${data?.name||''}"></label>
      <label>رقم الهاتف: <input id="f_phone" class="input" value="${data?.phone||''}"></label>
      <label>الوجهة: <input id="f_dest" class="input" value="${data?.dest||''}"></label>
      <label>ملاحظات: <input id="f_note" class="input" value="${data?.note||''}"></label>
      <label>صورة (رابط): <input id="f_image" class="input" value="${data?.image||''}"></label>
      <label>lat: <input id="f_lat" class="input" value="${data?.lat||''}"></label>
      <label>lon: <input id="f_lon" class="input" value="${data?.lon||''}"></label>
    `;
  } else if(type==='food'){
    formFields.innerHTML = `
      <label>اسم المطعم: <input id="f_rest" class="input" value="${data?.restaurant||''}"></label>
      <label>الوجبات: <input id="f_meals" class="input" value="${data?.meals||''}"></label>
      <label>رقم الهاتف: <input id="f_phone" class="input" value="${data?.phone||''}"></label>
      <label>صورة (رابط): <input id="f_image" class="input" value="${data?.image||''}"></label>
      <label>lat: <input id="f_lat" class="input" value="${data?.lat||''}"></label>
      <label>lon: <input id="f_lon" class="input" value="${data?.lon||''}"></label>
    `;
  } else if(type==='buses'){
    formFields.innerHTML = `
      <label>البلد/الوجهة: <input id="f_country" class="input" value="${data?.country||''}"></label>
      <label>وقت الإقلاع: <input id="f_depart" class="input" value="${data?.depart||''}"></label>
      <label>صاحب الحافلة: <input id="f_owner" class="input" value="${data?.owner||''}"></label>
      <label>رقم الهاتف: <input id="f_phone" class="input" value="${data?.phone||''}"></label>
      <label>صورة (رابط): <input id="f_image" class="input" value="${data?.image||''}"></label>
      <label>lat: <input id="f_lat" class="input" value="${data?.lat||''}"></label>
      <label>lon: <input id="f_lon" class="input" value="${data?.lon||''}"></label>
    `;
  } else if(type==='mosques'){
    formFields.innerHTML = `
      <label>اسم المسجد: <input id="f_mosque" class="input" value="${data?.mosqueName||''}"></label>
      <label>معلومات / ملاحظات: <input id="f_info" class="input" value="${data?.info||''}"></label>
      <label>صورة (رابط): <input id="f_image" class="input" value="${data?.image||''}"></label>
      <label>lat: <input id="f_lat" class="input" value="${data?.lat||''}"></label>
      <label>lon: <input id="f_lon" class="input" value="${data?.lon||''}"></label>
    `;
  } else if(type==='cafes'){
    formFields.innerHTML = `
      <label>اسم المقهى: <input id="f_cafe" class="input" value="${data?.cafeName||''}"></label>
      <label>معلومات / مشروبات مميزة: <input id="f_info" class="input" value="${data?.info||''}"></label>
      <label>صورة (رابط): <input id="f_image" class="input" value="${data?.image||''}"></label>
      <label>lat: <input id="f_lat" class="input" value="${data?.lat||''}"></label>
      <label>lon: <input id="f_lon" class="input" value="${data?.lon||''}"></label>
    `;
  } else if(type==='heritage'){
    formFields.innerHTML = `
      <label>عنوان التراث / المعلم: <input id="f_title" class="input" value="${data?.title||''}"></label>
      <label>وصف: <textarea id="f_info" rows="4" class="input">${data?.info||''}</textarea></label>
      <label>صورة (رابط): <input id="f_image" class="input" value="${data?.image||''}"></label>
    `;
  } else if(type==='areas'){
    formFields.innerHTML = `
      <label>اسم المنطقة: <input id="f_area" class="input" value="${data?.areaName||''}"></label>
      <label>ملاحظات: <input id="f_info" class="input" value="${data?.info||''}"></label>
      <label>صورة (رابط): <input id="f_image" class="input" value="${data?.image||''}"></label>
      <label>lat: <input id="f_lat" class="input" value="${data?.lat||''}"></label>
      <label>lon: <input id="f_lon" class="input" value="${data?.lon||''}"></label>
    `;
  }
}
$('#addType').addEventListener('change', ()=> buildFormFor($('#addType').value, null));
buildFormFor($('#addType').value, null);

let editing = null;
$('#addSave').addEventListener('click', async ()=>{
  const type = $('#addType').value;
  let obj = null;
  if(type==='cars'){
    obj = { name: $('#f_name').value.trim(), phone: $('#f_phone').value.trim(), dest: $('#f_dest').value.trim(), note: $('#f_note').value.trim(), image: $('#f_image').value.trim(), lat: parseFloat($('#f_lat').value)||null, lon: parseFloat($('#f_lon').value)||null };
  } else if(type==='food'){
    obj = { restaurant: $('#f_rest').value.trim(), meals: $('#f_meals').value.trim(), phone: $('#f_phone').value.trim(), image: $('#f_image').value.trim(), lat: parseFloat($('#f_lat').value)||null, lon: parseFloat($('#f_lon').value)||null };
  } else if(type==='buses'){
    obj = { country: $('#f_country').value.trim(), depart: $('#f_depart').value.trim(), owner: $('#f_owner').value.trim(), phone: $('#f_phone').value.trim(), image: $('#f_image').value.trim(), lat: parseFloat($('#f_lat').value)||null, lon: parseFloat($('#f_lon').value)||null };
  } else if(type==='mosques'){
    obj = { mosqueName: $('#f_mosque').value.trim(), info: $('#f_info').value.trim(), image: $('#f_image').value.trim(), lat: parseFloat($('#f_lat').value)||null, lon: parseFloat($('#f_lon').value)||null };
  } else if(type==='cafes'){
    obj = { cafeName: $('#f_cafe').value.trim(), info: $('#f_info').value.trim(), image: $('#f_image').value.trim(), lat: parseFloat($('#f_lat').value)||null, lon: parseFloat($('#f_lon').value)||null };
  } else if(type==='heritage'){
    obj = { title: $('#f_title').value.trim(), info: $('#f_info').value.trim(), image: $('#f_image').value.trim() };
  } else if(type==='areas'){
    obj = { areaName: $('#f_area').value.trim(), info: $('#f_info').value.trim(), image: $('#f_image').value.trim(), lat: parseFloat($('#f_lat').value)||null, lon: parseFloat($('#f_lon').value)||null };
  }
  if(!obj) return;
  if(editing && editing.type===type){
    DATA[type][editing.idx] = obj;
    editing = null;
  } else {
    if(!Array.isArray(DATA[type])) DATA[type] = [];
    DATA[type].push(obj);
  }
  saveLocal();
  await saveToFirebase();
  renderAdminList();
  renderFiltered();
  updateServiceMarkers();
  alert('تم الحفظ');
  buildFormFor($('#addType').value,null);
});
$('#addClear').addEventListener('click', ()=> { editing=null; buildFormFor($('#addType').value,null); });

/* render admin list with edit/delete */
function renderAdminList(){
  const filter = $('#adminFilter').value; const q = $('#adminSearch').value.trim().toLowerCase();
  const listEl = $('#adminList'); listEl.innerHTML='';
  const typesOrder = ['cars','food','buses','mosques','cafes','heritage','areas'];
  const items = [];
  typesOrder.forEach(type=>{
    if(filter!=='all' && filter!==type) return;
    const arr = DATA[type] || [];
    arr.forEach((it,i)=> items.push({type, idx:i, item:it}));
  });
  const filtered = items.filter(o=> !q || JSON.stringify(o.item).toLowerCase().includes(q));
  if(!filtered.length){ listEl.innerHTML = '<div class="muted">لا توجد عناصر</div>'; return; }

  listEl.innerHTML = filtered.map(o => {
    const it = o.item;
    let title = '';
    let meta = '';
    if(o.type==='cars'){ title = it.name || 'سيارة نقل'; meta = `${it.dest||''} • ${it.phone||''}`; }
    if(o.type==='food'){ title = it.restaurant || 'مطعم'; meta = `${it.meals||''} • ${it.phone||''}`; }
    if(o.type==='buses'){ title = `حافلة إلى ${it.country||''}`; meta = `${it.depart||''} • ${it.owner||''} • ${it.phone||''}`; }
    if(o.type==='mosques'){ title = it.mosqueName || 'مسجد'; meta = `${it.info||''}`; }
    if(o.type==='cafes'){ title = it.cafeName || 'مقهى'; meta = `${it.info||''}`; }
    if(o.type==='heritage'){ title = it.title || 'معلَم تراثي'; meta = `${(it.info||'').slice(0,80)}`; }
    if(o.type==='areas'){ title = it.areaName || 'منطقة'; meta = `${it.info||''}`; }

    return `<div class="admin-list-item">
      <div>
        <div style="font-weight:800">${title}</div>
        <div class="meta">${meta}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn small" onclick="editItem('${o.type}',${o.idx})">تعديل</button>
        <button class="btn small" onclick="deleteItemConfirm('${o.type}',${o.idx})">حذف</button>
      </div>
    </div>`;
  }).join('');
}
$('#refreshLists').addEventListener('click', ()=> renderAdminList());
$('#adminFilter').addEventListener('change', ()=> renderAdminList());
$('#adminSearch').addEventListener('input', ()=> renderAdminList());

window.editItem = function(type,idx){
  editing={type,idx}; showTab('add'); $$('#adminTabs button').forEach(b=>b.classList.remove('active')); $$('#adminTabs button')[1].classList.add('active');
  buildFormFor(type, DATA[type][idx]);
};

window.deleteItemConfirm = async function(type, idx){
  if(!confirm('هل أنت متأكد من حذف هذا العنصر؟')) return;
  DATA[type].splice(idx,1);
  saveLocal();
  await saveToFirebase();
  renderAdminList();
  renderFiltered();
  updateServiceMarkers();
};

/* import/export */
$('#exportJson').addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify(DATA,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='poostili-data.json'; a.click(); URL.revokeObjectURL(url); });
$('#importPaste').addEventListener('click', async ()=>{ const txt = $('#importArea').value.trim(); if(!txt) return alert('لا يوجد محتوى'); try{ const parsed=JSON.parse(txt); if(typeof parsed === 'object'){ DATA = Object.assign({cars:[],food:[],buses:[],mosques:[],cafes:[],heritage:[],areas:[]}, parsed); saveLocal(); await saveToFirebase(); renderAdminList(); renderFiltered(); updateServiceMarkers(); alert('تم الاستيراد'); } else alert('هيكل غير صالح'); }catch(e){ alert('خطأ في JSON'); }});
$('#importFile').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=async ()=>{ try{ const parsed=JSON.parse(r.result); if(typeof parsed === 'object'){ DATA = Object.assign({cars:[],food:[],buses:[],mosques:[],cafes:[],heritage:[],areas:[]}, parsed); saveLocal(); await saveToFirebase(); renderAdminList(); renderFiltered(); updateServiceMarkers(); alert('تم الاستيراد'); } else alert('هيكل غير صالح'); }catch(err){ alert('خطأ بصيغة الملف'); }}; r.readAsText(f); });

/* settings: change admin password in Firebase (we'll write to root admin_password) */
$('#changeAdminPass').addEventListener('click', async ()=>{
  const nw = $('#newAdminPass').value || '';
  if(!nw) return alert('أدخل كلمة مرور جديدة');
  try{
    await rtdb.ref('admin_password').set(nw);
    $('#newAdminPass').value = '';
    alert('تم تغيير كلمة المرور (مخزنة في Firebase).');
  }catch(e){ console.error(e); alert('خطأ عند حفظ كلمة المرور'); }
});

/* local clear */
$('#clearAll').addEventListener('click', ()=>{ if(!confirm('سيتم حذف كل البيانات المحلية (لا تؤثر على Firebase). استمر؟')) return; DATA = {cars:[],food:[],buses:[],mosques:[],cafes:[],heritage:[],areas:[]}; saveLocal(); renderAdminList(); renderFiltered(); updateServiceMarkers(); alert('تم المسح محليًا'); });

/* sharing */
function shareText(text){ if(navigator.share) return navigator.share({text}).catch(()=>{ location.href=`https://wa.me/?text=${encodeURIComponent(text)}` }); location.href=`https://wa.me/?text=${encodeURIComponent(text)}`; }
function smsText(text){ location.href=`sms:?&body=${encodeURIComponent(text)}`; }
$('#share-wa').addEventListener('click', ()=>{ getPosition().then(p=>{ shareText(`موقعي: https://www.google.com/maps?q=${p.latitude},${p.longitude}`); $('#share-status').textContent='تم فتح المشاركة'; }).catch(()=>{ shareText('موقعي: بلدية الخيثر'); $('#share-status').textContent='تم فتح المشاركة (موقع افتراضي)'; }); });
$('#share-sms').addEventListener('click', ()=>{ getPosition().then(p=>{ smsText(`موقعي: https://www.google.com/maps?q=${p.latitude},${p.longitude}`); $('#share-status').textContent='تم فتح الرسائل'; }).catch(()=>{ smsText('بلدية الخيثر'); $('#share-status').textContent='تم فتح الرسائل (موقع افتراضي)'; }); });

/* back top & install prompt */
$('#back-top').addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; $('#install').style.display='block'; });
$('#install').addEventListener('click', async ()=>{ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; $('#install').style.display='none'; } });

/* boot */
(async function boot(){
  $('#year').textContent = new Date().getFullYear();
  renderAllMain();
  let lat = FALLBACK.lat, lon = FALLBACK.lon;
  try{ const p = await getPosition(); lat = p.latitude; lon = p.longitude; $('#place').textContent = 'موقعك — بلدية الخيثر'; }
  catch(e){ $('#place').textContent = 'بلدية الخيثر — ولاية البيض (موقع افتراضي)'; }
  initMaps(lat,lon); loadWeather(lat,lon);
  $('#q').addEventListener('input', renderFiltered);
  $('#filter').addEventListener('change', renderFiltered);
  setInterval(()=>{ $('#time-now').textContent = new Date().toLocaleString('ar-DZ',{hour:'2-digit',minute:'2-digit'}) },1000);
  $$('.toggle').forEach(btn=>btn.addEventListener('click', ()=>{ const sec = btn.closest('.section'); sec.classList.toggle('open'); btn.setAttribute('aria-expanded', sec.classList.contains('open')); }));
  // default about section
  document.querySelector('[data-key="mosques"]').click();
})();
</script>
</body>
</html>