<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø«Ø§Ù†ÙˆÙŠØ© Ù…ÙØ¯ÙŠ Ø²ÙƒØ±ÙŠØ§ â€” Ø¥Ø¯Ø§Ø±Ø©</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
<style>
   :root {
            --primary: #1a237e;
            --primary-dark: #0d1440;
            --primary-light: #303f9f;
            --secondary: #121212;
            --accent: #00e5ff;
            --accent-glow: rgba(0, 229, 255, 0.7);
            --text: #e0e0e0;
            --text-light: #b0b0b0;
            --white: #1e1e1e;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.3);
            --radius: 16px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #0a0a2a 0%, #1a1a4a 100%);
            color: var(--text);
            line-height: 1.6;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        /* Ø®Ù„ÙÙŠØ© Ø§Ù„ÙØ¶Ø§Ø¡ */
        .space-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #eee, transparent),
                radial-gradient(2px 2px at 40px 70px, #fff, transparent),
                radial-gradient(1px 1px at 90px 40px, #ddd, transparent),
                radial-gradient(1px 1px at 130px 80px, #fff, transparent),
                radial-gradient(2px 2px at 160px 30px, #eee, transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: stars-animation 120s linear infinite;
        }

        .galaxy {
            position: absolute;
            top: 20%;
            right: 10%;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle at center, 
                rgba(74, 0, 224, 0.3) 0%, 
                rgba(74, 0, 224, 0.1) 40%, 
                transparent 70%);
            filter: blur(20px);
            animation: galaxy-rotate 100s linear infinite;
        }

        .nebula {
            position: absolute;
            bottom: 20%;
            left: 10%;
            width: 400px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(ellipse at center, 
                rgba(255, 0, 128, 0.2) 0%, 
                rgba(255, 0, 128, 0.05) 40%, 
                transparent 70%);
            filter: blur(30px);
            animation: nebula-pulse 20s ease-in-out infinite alternate;
        }

        .app {
            width: 100%;
            height: 100vh;
            background: rgba(10, 10, 30, 0.8);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--text);
            text-align: center;
            padding: 1.2rem;
            font-size: 1.3rem;
            font-weight: 700;
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid rgba(0, 229, 255, 0.3);
            text-shadow: 0 0 10px var(--accent-glow);
            z-index: 10;
        }

        header::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
            animation: shimmer 3s infinite;
        }

        .page-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            position: relative;
        }

        .page {
            display: none;
            animation: fadeInUp 0.5s ease-out;
            height: 100%;
        }

        .active {
            display: block;
        }

        .nav-tabs {
            display: flex;
            background: var(--secondary);
            border-bottom: 1px solid rgba(0, 229, 255, 0.2);
            overflow-x: auto;
            scrollbar-width: none;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 1rem 0.5rem;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: var(--text-light);
            white-space: nowrap;
            min-width: 80px;
        }

        .nav-tab.active {
            color: var(--accent);
            border-bottom: 3px solid var(--accent);
            background: rgba(0, 229, 255, 0.05);
            text-shadow: 0 0 8px var(--accent-glow);
        }

        .nav-tab:hover {
            background: rgba(0, 229, 255, 0.1);
        }

        input, select, textarea {
            width: 100%;
            padding: 1rem;
            margin: 0.7rem 0;
            border-radius: 12px;
            border: 2px solid rgba(0, 229, 255, 0.3);
            font-size: 1rem;
            font-family: 'Cairo', sans-serif;
            box-sizing: border-box;
            transition: var(--transition);
            background: rgba(20, 20, 40, 0.7);
            color: var(--text);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 229, 255, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.5);
            background: rgba(30, 30, 60, 0.7);
            transform: translateY(-2px);
        }

        button {
            width: 100%;
            padding: 1rem;
            margin: 0.7rem 0;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(0, 229, 255, 0.2) 0%, rgba(0, 229, 255, 0.1) 100%);
            color: var(--accent);
            border: 1px solid rgba(0, 229, 255, 0.4);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 700;
            font-size: 1rem;
            font-family: 'Cairo', sans-serif;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            text-shadow: 0 0 5px var(--accent-glow);
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 229, 255, 0.3) 0%, transparent 100%);
            transform: translateX(-100%);
            transition: var(--transition);
        }

        button:hover {
            background: linear-gradient(135deg, rgba(0, 229, 255, 0.3) 0%, rgba(0, 229, 255, 0.2) 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5), 0 0 15px var(--accent-glow);
        }

        button:hover::before {
            transform: translateX(0);
        }

        button:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5), 0 0 10px var(--accent-glow);
        }

        button.primary {
            background: linear-gradient(135deg, var(--accent) 0%, #00bcd4 100%);
            color: var(--primary-dark);
            border: 1px solid var(--accent);
            text-shadow: none;
        }

        button.secondary {
            background: linear-gradient(135deg, rgba(40, 40, 70, 0.7) 0%, rgba(30, 30, 60, 0.7) 100%);
            color: var(--text);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        button.secondary:hover {
            background: linear-gradient(135deg, rgba(50, 50, 90, 0.7) 0%, rgba(40, 40, 80, 0.7) 100%);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
            animation: tableFadeIn 0.6s ease-out;
            border: 1px solid rgba(0, 229, 255, 0.2);
        }

        th, td {
            border: 1px solid rgba(0, 229, 255, 0.2);
            padding: 0.8rem;
            text-align: center;
            transition: var(--transition);
        }

        th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--text);
            font-weight: 700;
            text-shadow: 0 0 8px var(--accent-glow);
        }

        tr:nth-child(even) {
            background: rgba(0, 229, 255, 0.05);
        }

        tr:hover {
            background: rgba(0, 229, 255, 0.1);
            transform: scale(1.01);
        }

        .error {
            color: #ff5252;
            font-size: 0.85rem;
            margin-top: -0.5rem;
            margin-bottom: 0.5rem;
            display: block;
            animation: shake 0.5s ease-in-out;
            text-shadow: 0 0 5px rgba(255, 82, 82, 0.7);
        }

        #newsTicker {
            overflow: hidden;
            white-space: nowrap;
            box-sizing: border-box;
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.7) 0%, rgba(30, 30, 60, 0.7) 100%);
            padding: 0.8rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            position: relative;
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(0, 229, 255, 0.2);
        }

        #newsTicker::before {
            content: 'ğŸ“¢';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
        }

        #newsTicker span {
            display: inline-block;
            padding-right: 40px;
            animation: ticker 20s linear infinite;
            font-weight: 600;
            color: var(--accent);
            text-shadow: 0 0 5px var(--accent-glow);
        }

        .card {
            background: rgba(20, 20, 40, 0.7);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            border: 1px solid rgba(0, 229, 255, 0.2);
            backdrop-filter: blur(5px);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.5), 0 0 15px rgba(0, 229, 255, 0.3);
        }

        .loader {
            border: 4px solid rgba(30, 30, 60, 0.7);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin: 0 auto;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        h3, h4 {
            color: var(--accent);
            text-shadow: 0 0 8px var(--accent-glow);
            margin-bottom: 1rem;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            background: rgba(30, 30, 60, 0.7);
            margin: 0.5rem 0;
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 229, 255, 0.2);
        }

        .available { color: #00e676; }
        .pending { color: #ff9800; }
        .borrowed { color: #2196f3; }
        .unavailable { color: #f44336; }

        @keyframes appSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes tableFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes ticker {
            0% {
                transform: translateX(100%);
            }
            100% {
                transform: translateX(-100%);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 229, 255, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(0, 229, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 229, 255, 0);
            }
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        @keyframes shake {
            0%, 100% {
                transform: translateX(0);
            }
            10%, 30%, 50%, 70%, 90% {
                transform: translateX(-5px);
            }
            20%, 40%, 60%, 80% {
                transform: translateX(5px);
            }
        }

        @keyframes stars-animation {
            from {
                transform: translateY(0);
            }
            to {
                transform: translateY(-100px);
            }
        }

        @keyframes galaxy-rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes nebula-pulse {
            from {
                opacity: 0.3;
                transform: scale(1);
            }
            to {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 480px) {
            .page-container {
                padding: 0.8rem;
            }
            
            .card {
                padding: 1.2rem;
            }
            
            header {
                padding: 1rem;
                font-size: 1.1rem;
            }
            
            input, select, button {
                padding: 0.9rem;
            }
            
            th, td {
                padding: 0.6rem 0.4rem;
                font-size: 0.85rem;
            }
            
            .galaxy, .nebula {
                display: none;
            }
        }
</style>
</head>
<body>
<div class="space-background">
    <div class="stars"></div>
    <div class="galaxy"></div>
    <div class="nebula"></div>
</div>

<div class="app">
  <header>Ø«Ø§Ù†ÙˆÙŠØ© Ù…ÙØ¯ÙŠ Ø²ÙƒØ±ÙŠØ§</header>

  <div class="page-container">
    <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div class="page active" id="homePage">
      <button onclick="openPage('studentRegister')" class="primary">ØªØ³Ø¬ÙŠÙ„ ØªÙ„Ù…ÙŠØ°</button>
      <button onclick="openPage('studentLogin')">Ø¯Ø®ÙˆÙ„ ØªÙ„Ù…ÙŠØ°</button>
      <button onclick="openPage('adminLogin')">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
      <button onclick="openPage('librarianLogin')">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©</button>
    </div>

    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù…ÙŠØ° -->
    <div class="page" id="studentRegister">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù…ÙŠØ°</h3>
      <input id="sName" placeholder="Ø§Ù„Ø¥Ø³Ù…">
      <span class="error" id="nameError"></span>
      <input id="sLast" placeholder="Ø§Ù„Ù„Ù‚Ø¨">
      <span class="error" id="lastError"></span>
      <input id="sClass" placeholder="Ø§Ù„Ù‚Ø³Ù…">
      <select id="sGender"><option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option><option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option></select>
      <input id="sPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <button onclick="registerStudent()">Ø¥Ø±Ø³Ø§Ù„</button>
      <button onclick="backToHome()" class="secondary">Ø±Ø¬ÙˆØ¹</button>
      <p id="registerMsg"></p>
    </div>

    <!-- Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù…ÙŠØ° -->
    <div class="page" id="studentLogin">
      <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù…ÙŠØ°</h3>
      <input id="loginName" placeholder="Ø§Ù„Ø¥Ø³Ù…">
      <input id="loginLast" placeholder="Ø§Ù„Ù„Ù‚Ø¨">
      <input id="loginPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <button onclick="loginStudent()">Ø¯Ø®ÙˆÙ„</button>
      <button onclick="backToHome()" class="secondary">Ø±Ø¬ÙˆØ¹</button>
      <p id="loginMsg"></p>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„ØªÙ„Ù…ÙŠØ° -->
    <div class="page" id="studentPage">
      <h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="studentWelcome"></span></h3>
      <button onclick="openPage('libraryPage')" class="primary">Ø§Ù„Ù…ÙƒØªØ¨Ø©</button>
      <div id="newsTicker"><span id="newsContent"></span></div>
      <h4>Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙƒ</h4>
      <ul id="studentMessages"></ul>
      <button onclick="logoutStudent()" class="secondary">Ø®Ø±ÙˆØ¬</button>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù„Ù„ØªÙ„Ù…ÙŠØ° -->
    <div class="page" id="libraryPage">
      <h3>Ø§Ù„Ù…ÙƒØªØ¨Ø©</h3>
      <input id="bookSearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨..." oninput="searchBooks()">
      <button onclick="renderBooks()" class="secondary">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨</button>
      <table id="booksTable"><tr><th>Ø§Ù„ÙƒØªØ§Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø·Ù„Ø¨</th></tr></table>
      <button onclick="backToStudent()" class="secondary">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <!-- Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ± -->
    <div class="page" id="adminLogin">
      <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
      <input id="adminPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±">
      <button onclick="loginAdmin()">Ø¯Ø®ÙˆÙ„</button>
      <button onclick="backToHome()" class="secondary">Ø±Ø¬ÙˆØ¹</button>
      <p id="adminMsg"></p>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± -->
    <div class="page" id="adminPage">
      <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h3>

      <h4>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h4>
      <table id="pendingStudentsTable"><tr><th>Ø§Ù„Ø¥Ø³Ù…</th><th>Ø§Ù„Ù„Ù‚Ø¨</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th><th>Ù‚Ø¨ÙˆÙ„</th><th>Ø­Ø°Ù</th></tr></table>

      <h4>Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ° Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„ÙˆÙ†</h4>
      <table id="acceptedStudentsTable"><tr><th>Ø§Ù„Ø¥Ø³Ù…</th><th>Ø§Ù„Ù„Ù‚Ø¨</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th><th>Ø­Ø°Ù</th></tr></table>

      <h4>Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
      <table id="newsTable"><tr><th>Ø§Ù„Ø®Ø¨Ø±</th><th>Ø­Ø°Ù</th></tr></table>

      <h4>Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h4>
      <input id="newsInput" placeholder="Ø£Ø¶Ù Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯">
      <button onclick="addNews()">Ø¥Ø±Ø³Ø§Ù„</button>
      <button onclick="backToHome()" class="secondary">Ø®Ø±ÙˆØ¬</button>
    </div>

    <!-- Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙƒØªØ¨ÙŠ -->
    <div class="page" id="librarianLogin">
      <h3>Ø¯Ø®ÙˆÙ„ ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙƒØªØ¨Ø©</h3>
      <input id="libPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙƒØªØ¨Ø©">
      <button onclick="loginLibrarian()">Ø¯Ø®ÙˆÙ„</button>
      <button onclick="backToHome()" class="secondary">Ø±Ø¬ÙˆØ¹</button>
      <p id="libMsg"></p>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ù…ÙƒØªØ¨ÙŠ -->
    <div class="page" id="librarianPage">
      <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø©</h3>
      <input id="newBookTitle" placeholder="Ø£Ø¶Ù ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯">
      <button onclick="addBook()">Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨</button>
      <table id="booksLibraryTable"><tr><th>Ø§Ù„ÙƒØªØ§Ø¨</th><th>Ù…ØªØ§Ø­ØŸ</th><th>Ø­Ø°Ù</th></tr></table>

      <h4>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØªØ¨</h4>
      <table id="requestsTable"><tr><th>Ø§Ø³Ù… Ø§Ù„ØªÙ„Ù…ÙŠØ°</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„ÙƒØªØ§Ø¨</th><th>Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</th><th>Ø§Ù„Ø±ÙØ¶</th></tr></table>

      <h3>Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø©</h3>
      <table id="borrowedBooksTable"><thead><tr><th>Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨</th><th>Ø§Ø³Ù… Ø§Ù„ØªÙ„Ù…ÙŠØ°</th><th>Ù…Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</th><th>Ø¥Ø±Ø¬Ø§Ø¹</th></tr></thead><tbody></tbody></table>

      <button onclick="logoutLibrarian()" class="secondary">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
</div>

<!-- Ø§Ø³ØªØ®Ø¯Ù… imports Ø§Ù„Ù…ÙˆØ¯ÙˆÙ„Ø§Ø± ÙÙ‚Ø· -->
<script type="module">
// Firebase (modular)
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, onSnapshot,
  updateDoc, doc, query, where, deleteDoc, getDoc
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA5mE3ywlxIkgSGSTGRBGx5Z1nt4dTNtac",
  authDomain: "mofdizakria-62b05.firebaseapp.com",
  projectId: "mofdizakria-62b05",
  storageBucket: "mofdizakria-62b05.appspot.com",
  messagingSenderId: "422813644523",
  appId: "1:422813644523:web:e779a0a84087d05a2870ae"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentStudent = null;
let allBooks = [];
let bookRequests = [];

// ---------- ØªÙ†Ù‚Ù„ ----------
window.openPage = id => { 
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); 
  document.getElementById(id).classList.add('active'); 
}

window.backToHome = () => openPage('homePage');
window.backToStudent = () => openPage('studentPage');

window.logoutStudent = () => { 
  currentStudent = null; 
  backToHome(); 
  renderNews(); 
  renderBooks(); 
  renderStudentMessages(); 
}

window.logoutLibrarian = () => backToHome();

// ---------- ØªØ³Ø¬ÙŠÙ„ ØªÙ„Ù…ÙŠØ° ----------
window.registerStudent = async () => {
  const name = document.getElementById('sName').value.trim();
  const last = document.getElementById('sLast').value.trim();
  const sClass = document.getElementById('sClass').value.trim();
  const gender = document.getElementById('sGender').value;
  const password = document.getElementById('sPassword').value.trim();
  const registerMsg = document.getElementById('registerMsg');

  if(!name || !last || !sClass || !password){ 
    registerMsg.innerText = 'Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„'; 
    return; 
  }

  try {
    // ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„ (name+last+sClass+gender)
    const qDup = query(collection(db,'pendingStudents'), 
      where('name','==',name), 
      where('last','==',last), 
      where('sClass','==',sClass), 
      where('gender','==',gender));
    const dupSnap = await getDocs(qDup);
    
    const qDup2 = query(collection(db,'acceptedStudents'), 
      where('name','==',name), 
      where('last','==',last), 
      where('sClass','==',sClass), 
      where('gender','==',gender));
    const dupSnap2 = await getDocs(qDup2);
    
    if(!dupSnap.empty || !dupSnap2.empty){ 
      registerMsg.innerText = 'ÙŠÙˆØ¬Ø¯ ØªÙ„Ù…ÙŠØ° Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª'; 
      return; 
    }

    await addDoc(collection(db,'pendingStudents'), { name, last, sClass, gender, password });
    registerMsg.innerText = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©';
    document.getElementById('sName').value=''; 
    document.getElementById('sLast').value=''; 
    document.getElementById('sClass').value=''; 
    document.getElementById('sPassword').value='';
  } catch (error) {
    console.error('Error registering student:', error);
    registerMsg.innerText = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
  }
}

// ---------- Ø¯Ø®ÙˆÙ„ ØªÙ„Ù…ÙŠØ° ----------
window.loginStudent = async () => {
  const name = document.getElementById('loginName').value.trim();
  const last = document.getElementById('loginLast').value.trim();
  const password = document.getElementById('loginPass').value.trim();
  
  if (!name || !last || !password) {
    document.getElementById('loginMsg').innerText = 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„';
    return;
  }
  
  try {
    const q = query(collection(db,'acceptedStudents'), 
      where('name','==',name), 
      where('last','==',last), 
      where('password','==',password));
    const snap = await getDocs(q);
    
    if(snap.empty){ 
      document.getElementById('loginMsg').innerText = 'Ø§Ù„Ø¥Ø³Ù…/Ø§Ù„Ù„Ù‚Ø¨ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©'; 
      return; 
    }
    
    const docSnap = snap.docs[0];
    currentStudent = { 
      id: docSnap.id, 
      ...docSnap.data() 
    };
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (!currentStudent.id || !currentStudent.name) {
      document.getElementById('loginMsg').innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
      return;
    }
    
    document.getElementById('studentWelcome').innerText = `${currentStudent.name} ${currentStudent.last}`;
    openPage('studentPage');
    renderNews(); 
    renderBooks(); 
    renderStudentMessages();
  } catch (error) {
    console.error('Login error:', error);
    document.getElementById('loginMsg').innerText = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
  }
}

// ---------- Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ----------
window.addNews = async () => {
  const newsInput = document.getElementById('newsInput');
  const news = newsInput.value.trim();
  if(!news) return;
  
  try {
    await addDoc(collection(db,'news'), { text: news, createdAt: Date.now() });
    newsInput.value = '';
    renderNews();
    renderNewsAdmin();
  } catch (error) {
    console.error('Error adding news:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¨Ø±');
  }
}

async function renderNews(){
  try {
    const snap = await getDocs(collection(db,'news'));
    const arr = [];
    snap.forEach(d=>arr.push(d.data().text));
    document.getElementById('newsContent').innerText = arr.join(' â€” ');
  } catch (error) {
    console.error('Error rendering news:', error);
  }
}
window.renderNews = renderNews;

async function renderNewsAdmin(){
  try {
    const table = document.getElementById('newsTable');
    table.innerHTML = '<tr><th>Ø§Ù„Ø®Ø¨Ø±</th><th>Ø­Ø°Ù</th></tr>';
    const snap = await getDocs(collection(db,'news'));
    snap.forEach(d=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${d.data().text}</td><td><button onclick="deleteNews('${d.id}')">Ø­Ø°Ù</button></td>`;
      table.appendChild(tr);
    });
  } catch (error) {
    console.error('Error rendering admin news:', error);
  }
}
window.renderNewsAdmin = renderNewsAdmin;

window.deleteNews = async (id) => {
  if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø®Ø¨Ø±ØŸ')) return;
  
  try {
    await deleteDoc(doc(db,'news',id));
    await renderNews(); 
    await renderNewsAdmin();
  } catch (error) {
    console.error('Error deleting news:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø®Ø¨Ø±');
  }
}

// ---------- Ù…Ø¯ÙŠØ±: Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Ø¨ÙˆÙ„/Ø­Ø°Ù ----------
async function renderPendingStudents(){
  try {
    const table = document.getElementById('pendingStudentsTable');
    table.innerHTML = '<tr><th>Ø§Ù„Ø¥Ø³Ù…</th><th>Ø§Ù„Ù„Ù‚Ø¨</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th><th>Ù‚Ø¨ÙˆÙ„</th><th>Ø­Ø°Ù</th></tr>';
    const snap = await getDocs(collection(db,'pendingStudents'));
    snap.forEach(d=>{
      const data = d.data();
      const row = table.insertRow();
      row.insertCell().innerText = data.name;
      row.insertCell().innerText = data.last;
      row.insertCell().innerText = data.sClass;
      row.insertCell().innerText = data.gender;
      row.insertCell().innerText = data.password;
      const btnAccept = document.createElement('button');
      btnAccept.innerText = 'Ù‚Ø¨ÙˆÙ„';
      btnAccept.onclick = ()=> approveStudent(d.id);
      row.insertCell().appendChild(btnAccept);
      const btnDel = document.createElement('button');
      btnDel.innerText = 'Ø­Ø°Ù';
      btnDel.onclick = ()=> deletePendingStudent(d.id);
      row.insertCell().appendChild(btnDel);
    });
  } catch (error) {
    console.error('Error rendering pending students:', error);
  }
}
window.renderPendingStudents = renderPendingStudents;

window.approveStudent = async (id) => {
  try {
    // Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØªÙ„Ù…ÙŠØ° (Ù†Ù‚Ù„ Ù…Ù† pending Ø¥Ù„Ù‰ accepted)
    const snap = await getDoc(doc(db,'pendingStudents',id));
    if(!snap.exists()) return;
    const data = snap.data();
    await addDoc(collection(db,'acceptedStudents'), data);
    await deleteDoc(doc(db,'pendingStudents',id));
    renderPendingStudents(); 
    renderAcceptedStudents();
  } catch (error) {
    console.error('Error approving student:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨');
  }
}

window.deletePendingStudent = async (id) => {
  try {
    await deleteDoc(doc(db,'pendingStudents',id));
    renderPendingStudents();
  } catch (error) {
    console.error('Error deleting pending student:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨');
  }
}

async function renderAcceptedStudents(){
  try {
    const table = document.getElementById('acceptedStudentsTable');
    table.innerHTML = '<tr><th>Ø§Ù„Ø¥Ø³Ù…</th><th>Ø§Ù„Ù„Ù‚Ø¨</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th><th>Ø­Ø°Ù</th></tr>';
    const snap = await getDocs(collection(db,'acceptedStudents'));
    snap.forEach(d=>{
      const data = d.data();
      const row = table.insertRow();
      row.insertCell().innerText = data.name;
      row.insertCell().innerText = data.last;
      row.insertCell().innerText = data.sClass;
      row.insertCell().innerText = data.gender;
      row.insertCell().innerText = data.password;
      const btnDel = document.createElement('button');
      btnDel.innerText = 'Ø­Ø°Ù';
      btnDel.onclick = ()=> deleteAcceptedStudent(d.id);
      row.insertCell().appendChild(btnDel);
    });
  } catch (error) {
    console.error('Error rendering accepted students:', error);
  }
}
window.renderAcceptedStudents = renderAcceptedStudents;

window.deleteAcceptedStudent = async (id) => {
  try {
    await deleteDoc(doc(db,'acceptedStudents',id));
    renderAcceptedStudents();
  } catch (error) {
    console.error('Error deleting accepted student:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨');
  }
}

// ---------- Ø§Ù„Ù…ÙƒØªØ¨ÙŠ: ÙƒØªØ¨ + Ø·Ù„Ø¨Ø§Øª + Ù…ÙˆØ§ÙÙ‚Ø©/Ø±ÙØ¶ + borrowedBooks ----------
window.addBook = async () => {
  const t = document.getElementById('newBookTitle').value.trim();
  if(!t) return;
  
  try {
    await addDoc(collection(db,'books'), { title: t, available: true });
    document.getElementById('newBookTitle').value = '';
    renderBooksLibrary(); 
    renderBooks();
  } catch (error) {
    console.error('Error adding book:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨');
  }
}

window.deleteBook = async (id) => {
  try {
    await deleteDoc(doc(db,'books',id));
    renderBooksLibrary(); 
    renderBooks();
  } catch (error) {
    console.error('Error deleting book:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨');
  }
}

async function renderBooksLibrary(){
  try {
    const table = document.getElementById('booksLibraryTable');
    table.innerHTML = '<tr><th>Ø§Ù„ÙƒØªØ§Ø¨</th><th>Ù…ØªØ§Ø­ØŸ</th><th>Ø­Ø°Ù</th></tr>';
    const snap = await getDocs(collection(db,'books'));
    snap.forEach(d=>{
      const data = d.data();
      const row = table.insertRow();
      row.insertCell().innerText = data.title;
      row.insertCell().innerText = data.available ? 'Ù…ØªØ§Ø­' : 'ØºÙŠØ± Ù…ØªØ§Ø­';
      const btnDel = document.createElement('button');
      btnDel.innerText = 'Ø­Ø°Ù';
      btnDel.onclick = ()=> deleteBook(d.id);
      row.insertCell().appendChild(btnDel);
    });
  } catch (error) {
    console.error('Error rendering books library:', error);
  }
}
window.renderBooksLibrary = renderBooksLibrary;

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒØªØ¨
window.searchBooks = async () => {
  const searchText = document.getElementById('bookSearch').value.toLowerCase().trim();
  if (!searchText) {
    renderBooks();
    return;
  }
  
  const filteredBooks = allBooks.filter(book => 
    book.title.toLowerCase().includes(searchText)
  );
  
  displayBooks(filteredBooks);
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function checkStudentAuth() {
  if (!currentStudent || !currentStudent.id) {
    alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    openPage('studentLogin');
    return false;
  }
  return true;
}

// Ø·Ù„Ø¨ Ø§Ù„ÙƒØªØ¨ Ù…Ù† Ø§Ù„ØªÙ„Ù…ÙŠØ°
window.requestBook = async (bookId, bookTitle) => {
  // ØªØ­Ù‚Ù‚ Ù…Ø²Ø¯ÙˆØ¬ Ù…Ù† ÙˆØ¬ÙˆØ¯ currentStudent
  if(!currentStudent || !currentStudent.id) { 
    alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); 
    openPage('studentLogin');
    return; 
  }
  
  try {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªÙ„Ù…ÙŠØ° Ù‚Ø¯ Ø·Ù„Ø¨ Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„
    const existingRequest = bookRequests.find(req => 
      req.studentId === currentStudent.id && req.bookId === bookId && req.status === 'pending'
    );
    
    if (existingRequest) {
      alert('Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø·Ù„Ø¨ Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
      return;
    }
    
    await addDoc(collection(db,'bookRequests'), {
      studentId: currentStudent.id,
      studentName: `${currentStudent.name} ${currentStudent.last}`,
      studentClass: currentStudent.sClass,
      bookId, bookTitle,
      status: 'pending',
      createdAt: Date.now()
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ù…Ø¨Ø§Ø´Ø±Ø©
    const button = document.querySelector(`button[data-book-id="${bookId}"]`);
    if (button) {
      button.innerText = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
      button.disabled = true;
    }
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    await loadBookRequests();
    alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
  } catch (error) {
    console.error('Error requesting book:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨');
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØªØ¨
async function loadBookRequests() {
  if (currentStudent && currentStudent.id) {
    try {
      const q = query(collection(db, 'bookRequests'), where('studentId', '==', currentStudent.id));
      const snap = await getDocs(q);
      bookRequests = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (error) {
      console.error('Error loading book requests:', error);
      bookRequests = [];
    }
  } else {
    bookRequests = [];
  }
}

// Ø¹Ø±Ø¶ Ø§Ù„ÙƒØªØ¨ Ù„Ù„ØªÙ„Ù…ÙŠØ°
async function renderBooks() {
  const tbl = document.getElementById('booksTable');
  tbl.innerHTML = '<tr><th>Ø§Ù„ÙƒØªØ§Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø·Ù„Ø¨</th></tr>';
  
  try {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨ ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØªØ¨
    const booksSnap = await getDocs(collection(db, 'books'));
    allBooks = booksSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØªØ¨ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (currentStudent && currentStudent.id) {
      await loadBookRequests();
    } else {
      bookRequests = [];
    }
    
    displayBooks(allBooks);
  } catch (error) {
    console.error('Error loading books:', error);
    tbl.innerHTML = '<tr><td colspan="3">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨</td></tr>';
  }
}

// Ø¹Ø±Ø¶ Ø§Ù„ÙƒØªØ¨ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
function displayBooks(books) {
  const tbl = document.getElementById('booksTable');
  tbl.innerHTML = '<tr><th>Ø§Ù„ÙƒØªØ§Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø·Ù„Ø¨</th></tr>';
  
  if (books.length === 0) {
    tbl.innerHTML = '<tr><td colspan="3">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨</td></tr>';
    return;
  }
  
  books.forEach(book => {
    const row = tbl.insertRow();
    row.insertCell().innerText = book.title;
    
    // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨
    let status = 'Ù…ØªØ§Ø­';
    let statusClass = 'available';
    let canRequest = book.available;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ø·Ù„ÙˆØ¨Ø§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„ØªÙ„Ù…ÙŠØ° Ø§Ù„Ø­Ø§Ù„ÙŠ
    const studentRequest = currentStudent ? 
      bookRequests.find(req => req.bookId === book.id && req.studentId === currentStudent.id) 
      : null;
    
    if (studentRequest) {
      if (studentRequest.status === 'pending') {
        status = 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©';
        statusClass = 'pending';
        canRequest = false;
      } else if (studentRequest.status === 'approved') {
        status = 'Ù…Ø³ØªØ¹Ø§Ø±';
        statusClass = 'borrowed';
        canRequest = false;
      }
    } else if (!book.available) {
      status = 'ØºÙŠØ± Ù…ØªØ§Ø­';
      statusClass = 'unavailable';
      canRequest = false;
    }
    
    const statusCell = row.insertCell();
    statusCell.innerText = status;
    statusCell.className = statusClass;
    
    const actionCell = row.insertCell();
    const btn = document.createElement('button');
    
    if (!currentStudent) {
      btn.innerText = 'Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø·Ù„Ø¨';
      btn.onclick = () => openPage('studentLogin');
    } else if (studentRequest) {
      if (studentRequest.status === 'pending') {
        btn.innerText = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
        btn.disabled = true;
      } else if (studentRequest.status === 'approved') {
        btn.innerText = 'Ù…Ø³ØªØ¹Ø§Ø±';
        btn.disabled = true;
      }
    } else if (canRequest) {
      btn.innerText = 'Ø·Ù„Ø¨';
      btn.onclick = () => requestBook(book.id, book.title);
    } else {
      btn.innerText = 'ØºÙŠØ± Ù…ØªØ§Ø­';
      btn.disabled = true;
    }
    
    btn.setAttribute('data-book-id', book.id);
    actionCell.appendChild(btn);
  });
}

window.renderBooks = renderBooks;

// Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø© (Ù„Ù„Ù…ÙƒØªØ¨ÙŠ)
async function renderRequests(){
  try {
    const table = document.getElementById('requestsTable');
    table.innerHTML = '<tr><th>Ø§Ø³Ù… Ø§Ù„ØªÙ„Ù…ÙŠØ°</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„ÙƒØªØ§Ø¨</th><th>Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</th><th>Ø§Ù„Ø±ÙØ¶</th></tr>';
    const snap = await getDocs(collection(db,'bookRequests'));
    snap.forEach(d=>{
      const data = d.data();
      if (data.status !== 'pending') return;
      
      const row = table.insertRow();
      row.insertCell().innerText = data.studentName;
      row.insertCell().innerText = data.studentClass;
      row.insertCell().innerText = data.bookTitle;
      const btnAp = document.createElement('button'); 
      btnAp.innerText='Ù…ÙˆØ§ÙÙ‚Ø©';
      btnAp.onclick = ()=> approveBook(d.id, data.bookId, data.bookTitle, data.studentId, data.studentName);
      row.insertCell().appendChild(btnAp);
      const btnRj = document.createElement('button'); 
      btnRj.innerText='Ø±ÙØ¶';
      btnRj.onclick = ()=> rejectBook(d.id, data.studentId, data.bookTitle);
      row.insertCell().appendChild(btnRj);
    });
  } catch (error) {
    console.error('Error rendering requests:', error);
  }
}
window.renderRequests = renderRequests;

window.approveBook = async (requestId, bookId, bookTitle, studentId, studentName) => {
  const days = prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¯Ø© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ø§Ù„Ø£ÙŠØ§Ù… (Ù…Ø«Ø§Ù„: 7):');
  if(!days) return;
  
  try {
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ù…ÙˆØ§ÙÙ‚
    await updateDoc(doc(db,'bookRequests', requestId), { status: 'approved' });
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨ Ø¥Ù„Ù‰ ØºÙŠØ± Ù…ØªØ§Ø­
    await updateDoc(doc(db,'books', bookId), { available: false });
    
    // Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø© ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© borrowedBooks
    const returnInfo = `${days} ÙŠÙˆÙ…/Ø£ÙŠØ§Ù…`;
    await addDoc(collection(db,'borrowedBooks'), {
      bookId, bookTitle, studentId, studentName, returnInfo, 
      borrowedAt: Date.now(), requestId: requestId
    });
    
    // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„ØªÙ„Ù…ÙŠØ°
    await addDoc(collection(db,'notifications'), {
      studentId, message: `ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ ÙƒØªØ§Ø¨ "${bookTitle}" Ù„Ù…Ø¯Ø© ${returnInfo}`, read: false, createdAt: Date.now()
    });
    
    renderRequests(); 
    renderBooksLibrary(); 
    renderBooks(); 
    renderBorrowedBooks(); 
    renderAdminNotifications();
    alert('ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„ØªÙ„Ù…ÙŠØ°');
  } catch (error) {
    console.error('Error approving book:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ§Ø¨');
  }
}

window.rejectBook = async (requestId, studentId, bookTitle) => {
  try {
    await updateDoc(doc(db,'bookRequests', requestId), { status: 'rejected' });
    await addDoc(collection(db,'notifications'), { 
      studentId, 
      message: `ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ ÙƒØªØ§Ø¨ "${bookTitle}"`, 
      read: false, 
      createdAt: Date.now() 
    });
    renderRequests(); 
    renderAdminNotifications();
    alert('ØªÙ… Ø§Ù„Ø±ÙØ¶ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„ØªÙ„Ù…ÙŠØ°');
  } catch (error) {
    console.error('Error rejecting book:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨');
  }
}

// ---------- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø© (onSnapshot Ù„ÙŠØ­Ø¯Ù‘Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹) ----------
const borrowedTbody = document.querySelector('#borrowedBooksTable tbody');
function renderBorrowedBooks(){ /* fallback if onSnapshot not yet bound */ }
window.renderBorrowedBooks = renderBorrowedBooks;

onSnapshot(collection(db,'borrowedBooks'), snapshot=>{
  // Ù†Ù…Ù„Ø£ tbody
  if(!borrowedTbody) return;
  borrowedTbody.innerHTML = '';
  snapshot.forEach(docSnap=>{
    const b = docSnap.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${b.bookTitle}</td>
      <td>${b.studentName}</td>
      <td>${b.returnInfo || ''}</td>
      <td><button onclick="returnBook('${docSnap.id}','${b.bookId}','${b.requestId}')">Ø¥Ø±Ø¬Ø§Ø¹</button></td>
    `;
    borrowedTbody.appendChild(tr);
  });
});

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒØªØ§Ø¨
window.returnBook = async (borrowId, bookId, requestId) => {
  if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒØªØ§Ø¨ØŸ')) return;
  
  try {
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ù…ÙƒØªÙ…Ù„
    if (requestId) {
      await updateDoc(doc(db,'bookRequests', requestId), { status: 'returned' });
    }
    
    // Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©
    await deleteDoc(doc(db,'borrowedBooks', borrowId));
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨ Ø¥Ù„Ù‰ Ù…ØªØ§Ø­
    await updateDoc(doc(db,'books', bookId), { available: true });
    
    renderBooksLibrary(); 
    renderBooks(); 
    renderBorrowedBooks();
    alert('ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒØªØ§Ø¨ ÙˆØ£ØµØ¨Ø­ Ù…ØªØ§Ø­Ø§Ù‹ Ù„Ù„Ø·Ù„Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
  } catch (error) {
    console.error('Error returning book:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒØªØ§Ø¨');
  }
}

// ---------- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ØªÙ„Ù…ÙŠØ° ----------
async function renderStudentMessages(){
  if(!currentStudent || !currentStudent.id) {
    const ul = document.getElementById('studentMessages');
    ul.innerHTML = '<li>ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</li>';
    return;
  }
  
  try {
    const ul = document.getElementById('studentMessages');
    ul.innerHTML = '';
    const q = query(collection(db,'notifications'), where('studentId','==', currentStudent.id));
    const snap = await getDocs(q);
    
    if (snap.empty) {
      ul.innerHTML = '<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</li>';
      return;
    }
    
    snap.forEach(d=>{
      const data = d.data();
      const li = document.createElement('li');
      li.innerHTML = `${data.message} ${data.read ? '(Ù…Ù‚Ø±ÙˆØ¡)' : '(ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡)'} 
        <button onclick="markNotifRead('${d.id}')">ÙˆØ¶Ø¹ ÙƒÙ…Ù‚Ø±ÙˆØ¡</button> 
        <button onclick="deleteNotif('${d.id}')">Ø­Ø°Ù</button>`;
      ul.appendChild(li);
    });
  } catch (error) {
    console.error('Error loading messages:', error);
    const ul = document.getElementById('studentMessages');
    ul.innerHTML = '<li>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</li>';
  }
}
window.renderStudentMessages = renderStudentMessages;

window.markNotifRead = async (id) => {
  if (!checkStudentAuth()) return;
  
  try {
    await updateDoc(doc(db,'notifications',id), { read: true });
    renderStudentMessages(); 
  } catch (error) {
    console.error('Error marking notification as read:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±');
  }
}

window.deleteNotif = async (id) => {
  if (!checkStudentAuth()) return;
  
  try {
    await deleteDoc(doc(db,'notifications',id));
    renderStudentMessages(); 
  } catch (error) {
    console.error('Error deleting notification:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±');
  }
}

// Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± (Ø¬Ø¯ÙˆÙ„ Ø¹Ø§Ù…)
async function renderAdminNotifications(){
  // ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
}
window.renderAdminNotifications = async () => {
  // ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
}

// ---------- Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„Ù…ÙƒØªØ¨ÙŠ Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹ (Ø¨ØªÙ‡ÙŠØ¦Ø© Ù‚ÙŠØ§Ø³ÙŠØ©) ----------
window.loginAdmin = async () => {
  const pass = document.getElementById('adminPass').value.trim();
  // Ø§ÙØªØ±Ø§Ø¶: Ù…Ø¬Ù…ÙˆØ¹Ø© 'admins' ØªØ­ØªÙˆÙŠ Ù…Ø³ØªÙ†Ø¯ ÙˆØ§Ø­Ø¯ Ù…Ø¹ Ø­Ù‚Ù„ password
  try {
    const snap = await getDocs(collection(db,'admins'));
    if(!snap.empty && snap.docs[0].data().password === pass){
      openPage('adminPage'); 
      renderPendingStudents(); 
      renderAcceptedStudents(); 
      renderNewsAdmin();
    } else {
      document.getElementById('adminMsg').innerText = 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©';
    }
  } catch (error) {
    console.error('Error logging in as admin:', error);
    document.getElementById('adminMsg').innerText = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
  }
}

window.loginLibrarian = async () => {
  const pass = document.getElementById('libPass').value.trim();
  try {
    const snap = await getDocs(collection(db,'librarians'));
    if(!snap.empty && snap.docs[0].data().password === pass){
      openPage('librarianPage'); 
      renderBooksLibrary(); 
      renderRequests(); 
      renderAdminNotifications();
    } else {
      document.getElementById('libMsg').innerText = 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©';
    }
  } catch (error) {
    console.error('Error logging in as librarian:', error);
    document.getElementById('libMsg').innerText = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
  }
}

// initialize views once
renderNews(); 
renderNewsAdmin(); 
renderBooksLibrary(); 
renderBooks(); 
renderPendingStudents(); 
renderAcceptedStudents(); 
renderRequests();

</script>
</body>
</html>